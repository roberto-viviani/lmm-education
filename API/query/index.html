
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../querydb/">
      
      
        <link rel="next" href="../workflows/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Module query.py - LM Markdown for Education</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Merriweather";--md-code-font:"Fira Code"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="slate" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lmm_education.query" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LM Markdown for Education" class="md-header__button md-logo" aria-label="LM Markdown for Education" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LM Markdown for Education
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Module query.py
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="slate" data-md-color-accent="custom"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LM Markdown for Education" class="md-nav__button md-logo" aria-label="LM Markdown for Education" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    LM Markdown for Education
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Handbook
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Handbook
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Handbook/Installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation and quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Handbook/RAGauthoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAG authoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Handbook/Markdown/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Working with Markdown
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Handbook/EncodingEmbedding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Encoding and Embedding
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Handbook/ChatApp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Main Chatbot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Handbook/Configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Architecture/Overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Architecture/Architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Outline Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Architecture/Implementation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Outline Implementation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Configuration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration modules
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Configuration/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Module config.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Configuration/appchat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Module appchat.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Apps
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Apps
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Apps/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Apps
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Apps/appChat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    App Chat
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Apps/appWebcast/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    App Webcast
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Utilities
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Utilities
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../appbase/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    App Base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../apputils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    App Utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../background_task_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Background Task Manager
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../logging_db/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Logging DB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    CLI
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    CLI
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli_lmme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LMME
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli_terminal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terminal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" checked>
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    RAG
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    RAG
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scan_rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Module scan_rag.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ingest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Module ingest.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../querydb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Module querydb.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Module query.py
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Module query.py
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query" class="md-nav__link">
    <span class="md-ellipsis">
      
        query
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query.aquery" class="md-nav__link">
    <span class="md-ellipsis">
      
        aquery
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query.create_chat_stream" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_chat_stream
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query.create_chat_stringstream" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_chat_stringstream
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query.history_to_messages" class="md-nav__link">
    <span class="md-ellipsis">
      
        history_to_messages
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query.query" class="md-nav__link">
    <span class="md-ellipsis">
      
        query
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6" >
        
          
          <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    LMM Workflows
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    LMM Workflows
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6_1" >
        
          
          <label class="md-nav__link" for="__nav_4_6_1" id="__nav_4_6_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Workflows and graphs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Workflows and graphs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workflow_base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chat_workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chat_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workflow_factory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Workflow factory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6_2" >
        
          
          <label class="md-nav__link" for="__nav_4_6_2" id="__nav_4_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Streams
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Streams
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stream_adapters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stream adapters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chat_stream_adapters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chat stream adapters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_7" >
        
          
          <label class="md-nav__link" for="__nav_4_7" id="__nav_4_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Vector Stores
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Vector Stores
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vector_store_qdrant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Module vector_store_qdrant.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vector_store_qdrant_langchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Module vector_store_qdrant_langchain.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vector_store_qdrant_context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Module vector store context
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vector_store_qdrant_utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Utilities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query" class="md-nav__link">
    <span class="md-ellipsis">
      
        query
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query.aquery" class="md-nav__link">
    <span class="md-ellipsis">
      
        aquery
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query.create_chat_stream" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_chat_stream
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query.create_chat_stringstream" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_chat_stringstream
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query.history_to_messages" class="md-nav__link">
    <span class="md-ellipsis">
      
        history_to_messages
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmm_education.query.query" class="md-nav__link">
    <span class="md-ellipsis">
      
        query
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Module query.py</h1>

<div class="doc doc-object doc-module">



<a id="lmm_education.query"></a>
    <div class="doc doc-contents first">

        <p>This module allows interactively querying a language model, such that
it can be tested using material ingested in the RAG database.</p>
<p>A RAG database must have been previously created (for example, with
the ingest module). In the following examples, we assume the
existence of a database on basic statistical modelling.</p>
<p>Examples:</p>
<pre><code class="language-bash"># Python called from the console

python -m lmm_education.query 'What is logistic regression?'
</code></pre>
<pre><code class="language-python"># from python code
from lmm_education.query import query

response = query('what is logistic regression?')
print(response)
</code></pre>
<p>Because ingest replaces the content of the database when documents
are edited, you can set up an ingest-evaluate loop:</p>
<pre><code class="language-bash"># Python called from the console

# append True to ingest the file 'LogisticRegression.md'
python -m lmm_education.ingest LogisticRegression.md True
python -m lmm_education.query 'what is logistic regression?'

Main functions:

- `create_chat_stream` and `create_chat_stringstream`: these functions
set up streams or LangGraph 'states' and of text, respectively, to
stream from the graph. They take as arguments the input to the graph
(i.e., the query text), a history of previous messages, a Workflow
context object for the graph, and optional parameters to configure the
function of the graph (validation of query) or the stream (logging
the exchange to a database).
- `query` and `aquery`: they take the query text and execute the
query, streaming the result. The provide an interface to config.toml,
but the settings contained there can be overridden by arguments.
Internally, they create a chat stream with a Workflow context
initialized from the config.toml parameters.

These two layers of functions handle construction of a streamable
graph to execute a query by taking care of the two layers of possible
specifications, i.e. from config.toml and for the components of the
graph.
</code></pre>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="lmm_education.query.aquery" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aquery</span><span class="p">(</span><span class="n">querystr</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">model_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chat_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">print_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validate_content</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allowed_content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">ConsoleLogger</span><span class="p">())</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Asynchronous generator that yields a text stream from the graph
coding the RAG chatting workflow.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>querystr</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query text to send to the language model</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_settings</code>
            </td>
            <td>
                  <code><span title="lmm.config.config.LanguageModelSettings">LanguageModelSettings</span> | <span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Language model settings (or 'major', 'minor',
'aux'). If None (default) take settings from config.toml</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chat_settings</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ChatSettings (lmm_education.config.appchat.ChatSettings)" href="../Configuration/appchat/#lmm_education.config.appchat.ChatSettings">ChatSettings</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Chat settings for the query</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>print_context</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, streams the RAG context</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>validate_content</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, validate response content</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allowed_content</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of allowed content types for validation</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>client</code>
            </td>
            <td>
                  <code><span title="qdrant_client.AsyncQdrantClient">AsyncQdrantClient</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional pre-configured Qdrant client</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>logger</code>
            </td>
            <td>
                  <code><span title="lmm.utils.logging.LoggerBase">LoggerBase</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logger instance for error reporting</p>
              </div>
            </td>
            <td>
                  <code><span title="lmm.utils.logging.ConsoleLogger">ConsoleLogger</span>()</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="collections.abc.AsyncIterator">AsyncIterator</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text chunks from the language model response</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="behaviour" open>
  <summary>Behaviour</summary>
  <p>On successful execution, it will yield the text chunks from
the language model response. If exceptions are raised, it
will yield an error message. Errors may also be propagated
through the logger. This behaviour is consistent with its
use in a CLI.</p>
</details>

<details class="example" open>
  <summary>Example</summary>
  <pre><code class="language-python"># assumes vector database is present
async for text in aquery(&quot;What is logistic regression?&quot;):
    print(text, end=&quot;&quot;, flush=True)
print()
</code></pre>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lmm_education/query.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aquery</span><span class="p">(</span>
    <span class="n">querystr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">model_settings</span><span class="p">:</span> <span class="n">LanguageModelSettings</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">chat_settings</span><span class="p">:</span> <span class="n">ChatSettings</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">print_context</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">validate_content</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">allowed_content</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">AsyncQdrantClient</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">LoggerBase</span> <span class="o">=</span> <span class="n">ConsoleLogger</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronous generator that yields a text stream from the graph</span>
<span class="sd">    coding the RAG chatting workflow.</span>

<span class="sd">    Args:</span>
<span class="sd">        querystr: The query text to send to the language model</span>
<span class="sd">        model_settings: Language model settings (or &#39;major&#39;, &#39;minor&#39;,</span>
<span class="sd">            &#39;aux&#39;). If None (default) take settings from config.toml</span>
<span class="sd">        chat_settings: Chat settings for the query</span>
<span class="sd">        print_context: If True, streams the RAG context</span>
<span class="sd">        validate_content: If True, validate response content</span>
<span class="sd">        allowed_content: List of allowed content types for validation</span>
<span class="sd">        client: Optional pre-configured Qdrant client</span>
<span class="sd">        logger: Logger instance for error reporting</span>

<span class="sd">    Yields:</span>
<span class="sd">        str: Text chunks from the language model response</span>

<span class="sd">    Behaviour:</span>
<span class="sd">        On successful execution, it will yield the text chunks from</span>
<span class="sd">        the language model response. If exceptions are raised, it</span>
<span class="sd">        will yield an error message. Errors may also be propagated</span>
<span class="sd">        through the logger. This behaviour is consistent with its</span>
<span class="sd">        use in a CLI.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # assumes vector database is present</span>
<span class="sd">        async for text in aquery(&quot;What is logistic regression?&quot;):</span>
<span class="sd">            print(text, end=&quot;&quot;, flush=True)</span>
<span class="sd">        print()</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">allowed_content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">allowed_content</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">config_settings</span><span class="p">:</span> <span class="n">ConfigSettings</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">load_settings</span><span class="p">(</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">config_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not load settings.&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s2">&quot;Could not load settings.&quot;</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">model_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_settings</span> <span class="o">=</span> <span class="n">config_settings</span><span class="o">.</span><span class="n">major</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_settings</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigSettings</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model_settings</span> <span class="o">==</span> <span class="s2">&quot;major&quot;</span><span class="p">:</span>
            <span class="n">model_settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">major</span>
        <span class="k">elif</span> <span class="n">model_settings</span> <span class="o">==</span> <span class="s2">&quot;minor&quot;</span><span class="p">:</span>
            <span class="n">model_settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">minor</span>
        <span class="k">elif</span> <span class="n">model_settings</span> <span class="o">==</span> <span class="s2">&quot;aux&quot;</span><span class="p">:</span>
            <span class="n">model_settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">aux</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errmsg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid language model settings: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_settings</span><span class="si">}</span><span class="se">\n</span><span class="s2">Should&quot;</span>
                <span class="s2">&quot; be one of &#39;major&#39;, &#39;minor&#39;, &#39;aux&#39;&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">errmsg</span>
            <span class="k">return</span>

    <span class="k">if</span> <span class="n">chat_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chat_settings</span> <span class="o">=</span> <span class="n">load_chat_settings</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chat_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not load chat settings&quot;</span><span class="p">)</span>
            <span class="k">yield</span> <span class="s2">&quot;Could not load chat settings.&quot;</span>
            <span class="k">return</span>

    <span class="k">if</span> <span class="n">validate_content</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allowed_content</span><span class="p">:</span>
        <span class="n">allowed_content</span> <span class="o">=</span> <span class="n">chat_settings</span><span class="o">.</span><span class="n">check_response</span><span class="o">.</span><span class="n">allowed_content</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_content</span><span class="p">:</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;A request to validate content was made, but there is&quot;</span>
                <span class="s2">&quot; no allowed content value in the configuration file.&quot;</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Add a list of allowed contents in the &quot;</span>
                <span class="s2">&quot;[check_response] section of &quot;</span> <span class="o">+</span> <span class="n">DEFAULT_CONFIG_FILE</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">errmsg</span>
            <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">retriever</span><span class="p">:</span> <span class="n">BaseRetriever</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">AsyncQdrantRetriever</span><span class="o">.</span><span class="n">from_config_settings</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load retriever: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;Could not load retriever: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span>

    <span class="c1"># Create dependency injection object</span>
    <span class="n">response_settings</span> <span class="o">=</span> <span class="n">CheckResponse</span><span class="p">(</span>
        <span class="n">check_response</span><span class="o">=</span><span class="n">validate_content</span><span class="p">,</span>
        <span class="n">allowed_content</span><span class="o">=</span><span class="n">allowed_content</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># this for override config settings</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ChatWorkflowContext</span><span class="p">(</span>
        <span class="n">retriever</span><span class="o">=</span><span class="n">retriever</span><span class="p">,</span>
        <span class="n">chat_settings</span><span class="o">=</span><span class="n">chat_settings</span><span class="o">.</span><span class="n">from_instance</span><span class="p">(</span>
            <span class="n">check_response</span><span class="o">=</span><span class="n">response_settings</span>
        <span class="p">),</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Get the iterator and consume it</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">iterator</span><span class="p">:</span> <span class="n">tier_3_iterator</span> <span class="o">=</span> <span class="n">create_chat_stringstream</span><span class="p">(</span>
            <span class="n">querystr</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">context</span><span class="p">,</span>
            <span class="n">print_context</span><span class="o">=</span><span class="n">print_context</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="n">response_settings</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load chat stream: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;Could not load chat stream: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">chunk</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">errmsg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Workflow streaming failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">errmsg</span>
        <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="lmm_education.query.create_chat_stream" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_chat_stream</span><span class="p">(</span><span class="n">querytext</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">stream_updates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">database_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">ConsoleLogger</span><span class="p">())</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Creates and configures the chat stream. Returns tuples of
(mode, event) items as returned from the graph.</p>
<p>This function retrieves a compiled LangGraph's graph, creates the
initial state, and returns a configured stream to process a user
query.</p>


<details class="note" open>
  <summary>Note</summary>
  <p>The tier_1_iterator contains all information from the graph
stream, and may be combined with other stream adaptors to
customize behaviour.
Use create_chat_stringstream to get a stream of strings.</p>
</details>        <p>Example:</p>
<pre><code>```python
try:
    stream = create_chat_stream(...)
    async for mode, event in stream:
        ...
except Exception as e:
    ...
```

```python
try:
    stream_raw = create_chat_stream(...)
    stream = tier_3_adapter(stream_raw)
    async for txt in stream:
        ...
except Exception as e:
    ...
```
</code></pre>
<p>Args:
    querytext: The user's query text
    history: List of previous message exchanges (Gradio format)
    context: a ChatWorkflowContext object for dependencies to be
        injected into the graph
    stream_updates: streams an updates channel (default to False)
    validate: if None, validates response using settings from
        context object. If False, carries out no validation. If a
        CheckReponse object, overrides the settings from
        the context object.
    database_log: if False (default), carries out no database
        logging of the exchanges. If True, carries out database
        logging with the settings defined in the context object,
        i.e. the files where the database is located. If a tuple
        of streams or file paths is provided, it uses those streams
        for logging.
    logger: Logger instance for info and error reporting</p>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="lmm_education.workflows.langchain.stream_adapters.tier_1_iterator">tier_1_iterator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(mode, event) tuples from the LLM stream</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="behaviour" open>
  <summary>Behaviour</summary>
  <p>This function does not stream the LLM response, it only sets
up the stream and returns it. Exceptions will be raised in
case the stream fails to initialize (usually, due to invalid
settings or failure to acquire resources).</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lmm_education/query.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_chat_stream</span><span class="p">(</span>
    <span class="n">querytext</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">context</span><span class="p">:</span> <span class="n">ChatWorkflowContext</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">stream_updates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">validate</span><span class="p">:</span> <span class="n">CheckResponse</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">database_log</span><span class="p">:</span> <span class="p">(</span>
        <span class="nb">bool</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">TextIOBase</span><span class="p">,</span> <span class="n">TextIOBase</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">LoggerBase</span> <span class="o">=</span> <span class="n">ConsoleLogger</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tier_1_iterator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and configures the chat stream. Returns tuples of</span>
<span class="sd">    (mode, event) items as returned from the graph.</span>

<span class="sd">    This function retrieves a compiled LangGraph&#39;s graph, creates the</span>
<span class="sd">    initial state, and returns a configured stream to process a user</span>
<span class="sd">    query.</span>

<span class="sd">    Note:</span>
<span class="sd">        The tier_1_iterator contains all information from the graph</span>
<span class="sd">        stream, and may be combined with other stream adaptors to</span>
<span class="sd">        customize behaviour.</span>
<span class="sd">        Use create_chat_stringstream to get a stream of strings.</span>

<span class="sd">    Example:</span>

<span class="sd">        ```python</span>
<span class="sd">        try:</span>
<span class="sd">            stream = create_chat_stream(...)</span>
<span class="sd">            async for mode, event in stream:</span>
<span class="sd">                ...</span>
<span class="sd">        except Exception as e:</span>
<span class="sd">            ...</span>
<span class="sd">        ```</span>

<span class="sd">        ```python</span>
<span class="sd">        try:</span>
<span class="sd">            stream_raw = create_chat_stream(...)</span>
<span class="sd">            stream = tier_3_adapter(stream_raw)</span>
<span class="sd">            async for txt in stream:</span>
<span class="sd">                ...</span>
<span class="sd">        except Exception as e:</span>
<span class="sd">            ...</span>
<span class="sd">        ```</span>
<span class="sd">    Args:</span>
<span class="sd">        querytext: The user&#39;s query text</span>
<span class="sd">        history: List of previous message exchanges (Gradio format)</span>
<span class="sd">        context: a ChatWorkflowContext object for dependencies to be</span>
<span class="sd">            injected into the graph</span>
<span class="sd">        stream_updates: streams an updates channel (default to False)</span>
<span class="sd">        validate: if None, validates response using settings from</span>
<span class="sd">            context object. If False, carries out no validation. If a</span>
<span class="sd">            CheckReponse object, overrides the settings from</span>
<span class="sd">            the context object.</span>
<span class="sd">        database_log: if False (default), carries out no database</span>
<span class="sd">            logging of the exchanges. If True, carries out database</span>
<span class="sd">            logging with the settings defined in the context object,</span>
<span class="sd">            i.e. the files where the database is located. If a tuple</span>
<span class="sd">            of streams or file paths is provided, it uses those streams</span>
<span class="sd">            for logging.</span>
<span class="sd">        logger: Logger instance for info and error reporting</span>

<span class="sd">    Yields:</span>
<span class="sd">        (mode, event) tuples from the LLM stream</span>

<span class="sd">    Behaviour:</span>
<span class="sd">        This function does not stream the LLM response, it only sets</span>
<span class="sd">        up the stream and returns it. Exceptions will be raised in</span>
<span class="sd">        case the stream fails to initialize (usually, due to invalid</span>
<span class="sd">        settings or failure to acquire resources).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Load settings.</span>
    <span class="n">config_settings</span><span class="p">:</span> <span class="n">ConfigSettings</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">load_settings</span><span class="p">(</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">config_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not load settings&quot;</span><span class="p">)</span>

    <span class="c1"># Retrieve settings for validation.</span>
    <span class="n">response_settings</span><span class="p">:</span> <span class="n">CheckResponse</span>
    <span class="k">match</span> <span class="n">validate</span><span class="p">:</span>
        <span class="k">case</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response_settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">chat_settings</span><span class="o">.</span><span class="n">check_response</span>
        <span class="k">case</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">response_settings</span> <span class="o">=</span> <span class="n">CheckResponse</span><span class="p">(</span><span class="n">check_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">CheckResponse</span><span class="p">():</span>
            <span class="n">response_settings</span> <span class="o">=</span> <span class="n">validate</span>

    <span class="c1"># Settings for logging.</span>
    <span class="n">chat_database</span><span class="p">:</span> <span class="n">ChatDatabaseInterface</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">match</span> <span class="n">database_log</span><span class="p">:</span>
        <span class="k">case</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">chat_database</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">case</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># create logger using config info.</span>
            <span class="n">db_settings</span><span class="p">:</span> <span class="n">ChatDatabase</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">context</span><span class="o">.</span><span class="n">chat_settings</span><span class="o">.</span><span class="n">chat_database</span>
            <span class="p">)</span>
            <span class="n">chat_database</span> <span class="o">=</span> <span class="n">CsvFileChatDatabase</span><span class="p">(</span>
                <span class="n">db_settings</span><span class="o">.</span><span class="n">messages_database_file</span><span class="p">,</span>
                <span class="n">db_settings</span><span class="o">.</span><span class="n">context_database_file</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">TextIOBase</span><span class="p">(),</span> <span class="n">TextIOBase</span><span class="p">()):</span>
            <span class="c1"># create logger using provided streams.</span>
            <span class="n">chat_database</span> <span class="o">=</span> <span class="n">CsvChatDatabase</span><span class="p">(</span>
                <span class="n">database_log</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">database_log</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">case</span> <span class="p">(</span><span class="nb">str</span><span class="p">(),</span> <span class="nb">str</span><span class="p">()):</span>
            <span class="c1"># create logger using provided file paths.</span>
            <span class="n">chat_database</span> <span class="o">=</span> <span class="n">CsvFileChatDatabase</span><span class="p">(</span>
                <span class="n">database_log</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">database_log</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="c1"># map dblogger to typed lambda (required for typing)</span>
    <span class="n">dblogger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ChatState</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">chat_database</span><span class="p">:</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_log_state</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ChatState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># chat_database is captured from closure,</span>
            <span class="c1"># but we verify it is not None for type checker</span>
            <span class="k">if</span> <span class="n">chat_database</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">graph_logger</span><span class="p">(</span>
                    <span class="n">database</span><span class="o">=</span><span class="n">chat_database</span><span class="p">,</span>
                    <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                    <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                    <span class="n">client_host</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">client_host</span><span class="p">,</span>
                    <span class="n">session_hash</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">session_hash</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">dblogger</span> <span class="o">=</span> <span class="n">_log_state</span>

    <span class="c1"># Fetch workflow graph from factory. The default is to</span>
    <span class="c1"># use the &#39;workflow&#39; graph, but also &#39;agent&#39; is supported</span>
    <span class="c1"># if set in appchat.toml.</span>
    <span class="n">wfname</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">context</span><span class="o">.</span><span class="n">chat_settings</span><span class="o">.</span><span class="n">workflow</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">workflow</span><span class="p">:</span> <span class="n">ChatStateGraphType</span> <span class="o">=</span> <span class="n">workflow_factory</span><span class="p">(</span>
            <span class="n">wfname</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">config_settings</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not create workflow </span><span class="si">{</span><span class="n">wfname</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="c1"># Create initial state</span>
    <span class="n">initial_state</span><span class="p">:</span> <span class="n">ChatState</span> <span class="o">=</span> <span class="n">initialize_state</span><span class="p">(</span>
        <span class="n">querytext</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">history_to_messages</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="k">if</span> <span class="n">history</span> <span class="k">else</span> <span class="p">[],</span>
        <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="c1"># Set up the stream</span>
    <span class="n">raw_stream</span><span class="p">:</span> <span class="n">tier_1_iterator</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">stream_graph_updates</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stream_updates</span>
        <span class="k">else</span> <span class="n">stream_graph_state</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Configure stream for validation requests</span>
    <span class="n">tier_1_stream</span><span class="p">:</span> <span class="n">tier_1_iterator</span> <span class="o">=</span> <span class="n">raw_stream</span>
    <span class="k">if</span> <span class="n">response_settings</span><span class="o">.</span><span class="n">check_response</span><span class="p">:</span>
        <span class="c1"># Initialize the validation model</span>
        <span class="n">allowed_content</span> <span class="o">=</span> <span class="n">response_settings</span><span class="o">.</span><span class="n">allowed_content</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># the allowed content here introduces categories that</span>
            <span class="c1"># the model uses to classify responses. The model will</span>
            <span class="c1"># always add categories such as &#39;general knowledge&#39; to</span>
            <span class="c1"># this list.</span>
            <span class="n">validator_model</span><span class="p">:</span> <span class="n">RunnableType</span> <span class="o">=</span> <span class="n">create_runnable</span><span class="p">(</span>
                <span class="s2">&quot;allowed_content_validator&quot;</span><span class="p">,</span>
                <span class="n">allowed_content</span><span class="o">=</span><span class="n">allowed_content</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not initialize validation model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="c1"># the allowed content here lists the acceptable categories.</span>
        <span class="c1"># It should be equal to the categories sent to the model above</span>
        <span class="c1"># or a subset of it.</span>
        <span class="n">tier_1_stream</span> <span class="o">=</span> <span class="n">stateful_validation_adapter</span><span class="p">(</span>
            <span class="n">raw_stream</span><span class="p">,</span>
            <span class="n">validator_model</span><span class="o">=</span><span class="n">validator_model</span><span class="p">,</span>
            <span class="n">allowed_content</span><span class="o">=</span><span class="n">allowed_content</span><span class="p">,</span>
            <span class="n">source_nodes</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;generate&quot;</span>
            <span class="p">],</span>  <span class="c1"># Only validate LLM-generated content</span>
            <span class="n">buffer_size</span><span class="o">=</span><span class="n">response_settings</span><span class="o">.</span><span class="n">initial_buffer_size</span><span class="p">,</span>
            <span class="n">error_message</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">chat_settings</span><span class="o">.</span><span class="n">MSG_WRONG_CONTENT</span><span class="p">,</span>
            <span class="n">continue_on_fail</span><span class="o">=</span><span class="n">response_settings</span><span class="o">.</span><span class="n">continue_on_fail</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">dblogger</span><span class="p">:</span>
        <span class="n">tier_1_stream</span> <span class="o">=</span> <span class="n">terminal_tier1_adapter</span><span class="p">(</span>
            <span class="n">tier_1_stream</span><span class="p">,</span> <span class="n">on_terminal_state</span><span class="o">=</span><span class="n">dblogger</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">wfname</span> <span class="o">==</span> <span class="s2">&quot;agent&quot;</span><span class="p">:</span>
        <span class="c1"># this eliminates streaming of context for the</span>
        <span class="c1"># &#39;agent&#39; workflow</span>
        <span class="n">tier_1_stream</span> <span class="o">=</span> <span class="n">tier_1_filter_messages_adapter</span><span class="p">(</span>
            <span class="n">tier_1_stream</span><span class="p">,</span> <span class="n">exclude_nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tool_caller&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">tier_1_stream</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="lmm_education.query.create_chat_stringstream" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_chat_stringstream</span><span class="p">(</span><span class="n">querytext</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">print_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">database_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">ConsoleLogger</span><span class="p">())</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Creates and configures the chat stream.</p>
<p>This function retrieves a compiled LangGraph's graph, creates the
initial state, and returns a configured stream to process a user
query.</p>
<p>Example:</p>
<pre><code>```python
try:
    stream = create_chat_stream(...)
    async for chunk in stream:
        ...
except Exception as e:
    ...
```
</code></pre>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>querytext</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user's query text</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>history</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="str">str</span>]] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of previous message exchanges (Gradio format)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="lmm_education.workflows.langchain.chat_graph.ChatWorkflowContext">ChatWorkflowContext</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a ChatWorkflowContext object for dependencies to be
injected into the graph</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>print_context</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>streams the retrieved context (default to False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>validate</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="CheckResponse (lmm_education.config.appchat.CheckResponse)" href="../Configuration/appchat/#lmm_education.config.appchat.CheckResponse">CheckResponse</a> | <span title="typing.Literal">Literal</span>[False] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if None, validates response using settings from
context object. If False, carries out no validation. If a
CheckReponse object, overrides the settings from
the context object.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>database_log</code>
            </td>
            <td>
                  <code><span title="bool">bool</span> | <span title="tuple">tuple</span>[<span title="io.TextIOBase">TextIOBase</span>, <span title="io.TextIOBase">TextIOBase</span>] | <span title="tuple">tuple</span>[<span title="str">str</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if False (default), carries out no database
logging of the exchanges. If True, carries out database
logging with the settings defined in the context object,
i.e. the files where the database is located. If a tuple
of streams or file paths is provided, it uses those streams
for logging.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>logger</code>
            </td>
            <td>
                  <code><span title="lmm.utils.logging.LoggerBase">LoggerBase</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logger instance for info and error reporting</p>
              </div>
            </td>
            <td>
                  <code><span title="lmm.utils.logging.ConsoleLogger">ConsoleLogger</span>()</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="lmm_education.workflows.langchain.stream_adapters.tier_3_iterator">tier_3_iterator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>strings from the LLM stream</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="behaviour" open>
  <summary>Behaviour</summary>
  <p>This function does not stream the LLM response, it only sets
up the stream and returns it. Exceptions will be raised in
case the stream fails to initialize (usually, due to invalid
settings or failure to acquire resources).</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lmm_education/query.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_chat_stringstream</span><span class="p">(</span>
    <span class="n">querytext</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">context</span><span class="p">:</span> <span class="n">ChatWorkflowContext</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">print_context</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">validate</span><span class="p">:</span> <span class="n">CheckResponse</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">database_log</span><span class="p">:</span> <span class="p">(</span>
        <span class="nb">bool</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">TextIOBase</span><span class="p">,</span> <span class="n">TextIOBase</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">LoggerBase</span> <span class="o">=</span> <span class="n">ConsoleLogger</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tier_3_iterator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and configures the chat stream.</span>

<span class="sd">    This function retrieves a compiled LangGraph&#39;s graph, creates the</span>
<span class="sd">    initial state, and returns a configured stream to process a user</span>
<span class="sd">    query.</span>

<span class="sd">    Example:</span>

<span class="sd">        ```python</span>
<span class="sd">        try:</span>
<span class="sd">            stream = create_chat_stream(...)</span>
<span class="sd">            async for chunk in stream:</span>
<span class="sd">                ...</span>
<span class="sd">        except Exception as e:</span>
<span class="sd">            ...</span>
<span class="sd">        ```</span>

<span class="sd">    Args:</span>
<span class="sd">        querytext: The user&#39;s query text</span>
<span class="sd">        history: List of previous message exchanges (Gradio format)</span>
<span class="sd">        context: a ChatWorkflowContext object for dependencies to be</span>
<span class="sd">            injected into the graph</span>
<span class="sd">        print_context: streams the retrieved context (default to False)</span>
<span class="sd">        validate: if None, validates response using settings from</span>
<span class="sd">            context object. If False, carries out no validation. If a</span>
<span class="sd">            CheckReponse object, overrides the settings from</span>
<span class="sd">            the context object.</span>
<span class="sd">        database_log: if False (default), carries out no database</span>
<span class="sd">            logging of the exchanges. If True, carries out database</span>
<span class="sd">            logging with the settings defined in the context object,</span>
<span class="sd">            i.e. the files where the database is located. If a tuple</span>
<span class="sd">            of streams or file paths is provided, it uses those streams</span>
<span class="sd">            for logging.</span>
<span class="sd">        logger: Logger instance for info and error reporting</span>

<span class="sd">    Yields:</span>
<span class="sd">        strings from the LLM stream</span>

<span class="sd">    Behaviour:</span>
<span class="sd">        This function does not stream the LLM response, it only sets</span>
<span class="sd">        up the stream and returns it. Exceptions will be raised in</span>
<span class="sd">        case the stream fails to initialize (usually, due to invalid</span>
<span class="sd">        settings or failure to acquire resources).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stream</span><span class="p">:</span> <span class="n">tier_1_iterator</span> <span class="o">=</span> <span class="n">create_chat_stream</span><span class="p">(</span>
        <span class="n">querytext</span><span class="o">=</span><span class="n">querytext</span><span class="p">,</span>
        <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
        <span class="n">stream_updates</span><span class="o">=</span><span class="n">print_context</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span>
        <span class="n">database_log</span><span class="o">=</span><span class="n">database_log</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">print_context</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">terminal_field_change_adapter</span><span class="p">(</span>
            <span class="n">stream</span><span class="p">,</span>
            <span class="n">on_field_change</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="s2">&quot;CONTEXT:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="n">c</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">END CONTEXT------</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tier_1_to_3_adapter</span><span class="p">(</span>
            <span class="n">stream</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="lmm_education.query.history_to_messages" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">history_to_messages</span><span class="p">(</span><span class="n">history</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Convert Gradio history format to LangChain messages.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>history</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Gradio-format history list</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="langchain_core.messages.HumanMessage">HumanMessage</span> | <span title="langchain_core.messages.AIMessage">AIMessage</span> | <span title="langchain_core.messages.BaseMessage">BaseMessage</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of LangChain message objects</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lmm_education/query.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">history_to_messages</span><span class="p">(</span>
    <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">HumanMessage</span> <span class="o">|</span> <span class="n">AIMessage</span> <span class="o">|</span> <span class="n">BaseMessage</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert Gradio history format to LangChain messages.</span>

<span class="sd">    Args:</span>
<span class="sd">        history: Gradio-format history list</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of LangChain message objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">HumanMessage</span> <span class="o">|</span> <span class="n">AIMessage</span> <span class="o">|</span> <span class="n">BaseMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">messages</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="lmm_education.query.query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">query</span><span class="p">(</span><span class="n">querystr</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">model_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chat_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">print_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validate_content</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allowed_content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">ConsoleLogger</span><span class="p">())</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Synchronous generator that yields a text stream from the graph
coding the RAG chatting workflow.</p>
<p>This is a convenience wrapper that allows synchronous code to
consume the streaming response from the language model. It
creates an event loop internally to bridge the async/sync
boundary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>querystr</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query text to send to the language model</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_settings</code>
            </td>
            <td>
                  <code><span title="lmm.config.config.LanguageModelSettings">LanguageModelSettings</span> | <span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Language model settings (or 'major', 'minor',
'aux'). If None (default) take settings from config.toml</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chat_settings</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ChatSettings (lmm_education.config.appchat.ChatSettings)" href="../Configuration/appchat/#lmm_education.config.appchat.ChatSettings">ChatSettings</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Chat settings for the query</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>print_context</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, streams the RAG context</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>validate_content</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, validate response content</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allowed_content</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of allowed content types for validation</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>logger</code>
            </td>
            <td>
                  <code><span title="lmm.utils.logging.LoggerBase">LoggerBase</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logger instance for error reporting</p>
              </div>
            </td>
            <td>
                  <code><span title="lmm.utils.logging.ConsoleLogger">ConsoleLogger</span>()</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text chunks from the language model response</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="behaviour" open>
  <summary>Behaviour</summary>
  <p>On successful execution, it will yield the text chunks from
the language model response. If exceptions are raised, it
will yield an error message. Errors may also be propagated
through the logger. This behaviour is consistent with its
use in a CLI.</p>
</details>

<details class="example" open>
  <summary>Example</summary>
  <pre><code class="language-python"># assumes a RAG vector database has been created
for text in query(&quot;What is logistic regression?&quot;):
    print(text, end=&quot;&quot;, flush=True)
print()
</code></pre>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lmm_education/query.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span>
    <span class="n">querystr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">model_settings</span><span class="p">:</span> <span class="n">LanguageModelSettings</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">chat_settings</span><span class="p">:</span> <span class="n">ChatSettings</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">print_context</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">validate_content</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">allowed_content</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">LoggerBase</span> <span class="o">=</span> <span class="n">ConsoleLogger</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Synchronous generator that yields a text stream from the graph</span>
<span class="sd">    coding the RAG chatting workflow.</span>

<span class="sd">    This is a convenience wrapper that allows synchronous code to</span>
<span class="sd">    consume the streaming response from the language model. It</span>
<span class="sd">    creates an event loop internally to bridge the async/sync</span>
<span class="sd">    boundary.</span>

<span class="sd">    Args:</span>
<span class="sd">        querystr: The query text to send to the language model</span>
<span class="sd">        model_settings: Language model settings (or &#39;major&#39;, &#39;minor&#39;,</span>
<span class="sd">            &#39;aux&#39;). If None (default) take settings from config.toml</span>
<span class="sd">        chat_settings: Chat settings for the query</span>
<span class="sd">        print_context: If True, streams the RAG context</span>
<span class="sd">        validate_content: If True, validate response content</span>
<span class="sd">        allowed_content: List of allowed content types for validation</span>
<span class="sd">        logger: Logger instance for error reporting</span>

<span class="sd">    Yields:</span>
<span class="sd">        str: Text chunks from the language model response</span>

<span class="sd">    Behaviour:</span>
<span class="sd">        On successful execution, it will yield the text chunks from</span>
<span class="sd">        the language model response. If exceptions are raised, it</span>
<span class="sd">        will yield an error message. Errors may also be propagated</span>
<span class="sd">        through the logger. This behaviour is consistent with its</span>
<span class="sd">        use in a CLI.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # assumes a RAG vector database has been created</span>
<span class="sd">        for text in query(&quot;What is logistic regression?&quot;):</span>
<span class="sd">            print(text, end=&quot;&quot;, flush=True)</span>
<span class="sd">        print()</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.asyncutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_gen_to_sync_iter</span>

    <span class="c1"># Create the async generator object</span>
    <span class="n">async_gen</span><span class="p">:</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">aquery</span><span class="p">(</span>
        <span class="n">querystr</span><span class="p">,</span>
        <span class="n">model_settings</span><span class="o">=</span><span class="n">model_settings</span><span class="p">,</span>
        <span class="n">chat_settings</span><span class="o">=</span><span class="n">chat_settings</span><span class="p">,</span>
        <span class="n">print_context</span><span class="o">=</span><span class="n">print_context</span><span class="p">,</span>
        <span class="n">validate_content</span><span class="o">=</span><span class="n">validate_content</span><span class="p">,</span>
        <span class="n">allowed_content</span><span class="o">=</span><span class="n">allowed_content</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Iterate synchronously and yield text from each chunk</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">async_gen_to_sync_iter</span><span class="p">(</span><span class="n">async_gen</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">chunk</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
    show_root_heading: false</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>